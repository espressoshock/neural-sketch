%-----------------------------------------------------------
% Dev live unpacked .sty
%-----------------------------------------------------------

% RequirePackages ------------------------------------------
\RequirePackage{tikz}
\RequirePackage{expl3}
\usetikzlibrary{shapes.geometric}

\ExplSyntaxOn

%-----------------------------------------------------------
% Global props -
% to track auto-increment counters
%-----------------------------------------------------------
\prop_new:N \g_nsk_block_counters_prop

%-----------------------------------------------------------
% Block Primitive
%-----------------------------------------------------------
\keys_define:nn {nsk / block}
{
	% block type -----------------------------------------------
	type .tl_set:N = \l_nsk_block_type_tl,
	type .initial:n = {rectangle},
	type .default:n = {rectangle},

	% ref-id ---------------------------------------------------
	id .tl_set:N = \l_nsk_block_id_tl,
	id .initial:n = { },

	% coords  ---------------------------------------------------
	x .fp_set:N = \l_nsk_block_x_fp,
	x .initial:n = {0},
	x .default:n = {0},
	y .fp_set:N = \l_nsk_block_y_fp,
	y .initial:n  = {0},
	y .default:n = {0},

	% dimensions  -----------------------------------------------
	width .dim_set:N =  \l_nsk_block_width_dim,
	width .initial:n = {1cm},
	width .default:n = {1cm},

	height .dim_set:N = \l_nsk_block_height_dim,
	height .default:n = {1cm},
	height .initial:n = {1cm},

	% styles  ---------------------------------------------------
	border-type .choice:,
	border-type / solid .code:n = \tl_set:Nn \l_nsk_block_border_type_tl { solid },
	border-type / dashed .code:n = \tl_set:Nn \l_nsk_block_border_type_tl { dashed },
	border-type .initial:n = { solid },
	border-type .default:n = { solid },

	border-color .tl_set:N = \l_nsk_block_border_color_tl,
	border-color .initial:n = {red},
	border-color .default:n = {red},

	fill .tl_set:N = \l_nsk_block_fill_tl,
	fill .initial:n = {yellow},
}

%-----------------------------------------------------------
% Auto-generate an ID if user does not supply one
%-----------------------------------------------------------
\cs_new_protected_nopar:Npn \nsk__maybe_set_id:
{
	\tl_if_blank:VTF \l_nsk_block_id_tl
	{ \nsk__assign_autogenerated_id: }
	{ }
}

\cs_new_protected_nopar:Npn \nsk__assign_autogenerated_id:
{
	% If shape key not in the counters prop yet, init to 0
	\prop_if_in:NVF \g_nsk_block_counters_prop \l_nsk_block_type_tl
	{
		% (★) Use \prop_gput to store globally:
		\prop_gput:NVn \g_nsk_block_counters_prop \l_nsk_block_type_tl { 0 }
	}

	% Retrieve current count
	\prop_get:NVN \g_nsk_block_counters_prop \l_nsk_block_type_tl \l_tmpa_tl

	% Convert to int and increment
	\int_set:Nn \l_tmpa_int { \l_tmpa_tl + 1 }

	% (★) Update the counters property globally:
	\prop_gput:NVx \g_nsk_block_counters_prop \l_nsk_block_type_tl { \int_use:N \l_tmpa_int }

	% Construct "diamond1", "diamond2", "rectangle3", etc.
	\tl_set:No \l_nsk_block_id_tl
	{
		\tl_use:N \l_nsk_block_type_tl
		\int_use:N \l_tmpa_int
	}
}


\cs_new_protected_nopar:Npn \nsk__block_debug:
{
	\iow_term:x {type   = \tl_use:N \l_nsk_block_type_tl}
	\iow_term:x {x      = \fp_use:N \l_nsk_block_x_fp}
	\iow_term:x {y      = \fp_use:N \l_nsk_block_y_fp}
	\iow_term:x {width  = \dim_use:N \l_nsk_block_width_dim}
	\iow_term:x {height = \dim_use:N \l_nsk_block_height_dim}
}


\cs_new_protected_nopar:Npn \nsk__draw_block_aux:n #1
{
	\node [
		% at={(40, 3)},
		#1,
	] {};
}

% Generate a "V V V V" variant so that we can pass token-list
% variables or dimension variables by *value*.
\cs_generate_variant:Nn \nsk__draw_block_aux:n { V }

\cs_new_protected_nopar:Npn \nsk__build_block_style:
{
	% Build the style token list incrementally:
	\tl_clear_new:N \l_tmps_tl

	% id-ref ---------------------------------------------------
	\tl_put_right:No \l_tmps_tl { name=\l_nsk_block_id_tl,}

	% {x,y} pos ------------------------------------------------
	\tl_put_right:Nx \l_tmps_tl
	{at={(\fp_use:N \l_nsk_block_x_fp,\fp_use:N \l_nsk_block_y_fp)},}

	% shape-type -----------------------------------------------
	\tl_put_right:No \l_tmps_tl {shape=\l_nsk_block_type_tl,}
	% dims -----------------------------------------------------
	\tl_put_right:No \l_tmps_tl {minimum\space width=\l_nsk_block_width_dim,}
	\tl_put_right:No \l_tmps_tl {minimum\space height=\l_nsk_block_height_dim,}
	% borders --------------------------------------------------
	\tl_put_right:No \l_tmps_tl {draw=\l_nsk_block_border_color_tl,}
	\tl_put_right:No \l_tmps_tl {\l_nsk_block_border_type_tl,}
	% fill -----------------------------------------------------
	\tl_put_right:No \l_tmps_tl {fill=\l_nsk_block_fill_tl,}

	% Now call the *variant* function which takes
	% params by value:
	\nsk__draw_block_aux:V
	\l_tmps_tl
}


\cs_new_protected_nopar:Npn \nsk__draw_block:
{
	\nsk__build_block_style:
}

%-----------------------------------------------------------
% Public Interface
% (user-facing)
%-----------------------------------------------------------
\NewDocumentCommand \nskBlock { O{} }
{
	\group_begin:
	% # 1 -> k=v list
	\keys_set:nn {nsk / block } {#1}

	% possibly autogenerate the id
	\nsk__maybe_set_id:

	\nsk__block_debug:

	\nsk__build_block_style:

	\group_end:
}

\ExplSyntaxOff
